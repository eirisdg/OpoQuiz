{% extends "base.html" %}

{% block title %}{{ test_data.title }} - Test Generator{% endblock %}

{% block header_title %}{{ test_data.title }}{% endblock %}
{% block header_subtitle %}Pregunta {{ current_question + 1 }} de {{ total_questions }}{% endblock %}

{% block extra_nav %}
<a href="/results/{{ session_id }}" class="nav-link" onclick="return confirmExit()">
    üèÅ Finalizar Test
</a>
{% endblock %}

{% block content %}
    <!-- Progress Bar -->
    <div class="progress-bar">
        <div class="progress-fill" style="width: {{ ((current_question + 1) / total_questions * 100)|round(1) }}%"></div>
    </div>
    
    <!-- Question Info -->
    <div class="card">
        <div class="card-header">
            <div class="question-meta">
                <span class="question-category">{{ question.category.replace('_', ' ').title() }}</span>
                <span class="question-difficulty difficulty-{{ question.difficulty }}">
                    {{ question.difficulty.title() }}
                </span>
                {% if question.points > 1 %}
                <span class="question-points">{{ question.points }} puntos</span>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <h2 class="question-title">{{ question.question }}</h2>
        </div>
    </div>

    <!-- Answer Options -->
    <div class="card">
        <div class="card-body">
            <div class="radio-group">
                {% for i in range(4) %}
                <label class="radio-option" onclick="selectAnswer({{ i }})">
                    <input type="radio" name="answer" value="{{ i }}" {% if selected_answer == i %}checked{% endif %}>
                    <span class="option-text">{{ question.options[i] }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="card">
        <div class="card-body">
            <div class="nav-buttons">
                {% if current_question > 0 %}
                <button class="btn btn-outline" onclick="previousQuestion()">
                    ‚Üê Anterior
                </button>
                {% endif %}
                
                <div class="nav-info">
                    <span class="current-position">{{ current_question + 1 }}/{{ total_questions }}</span>
                </div>
                
                {% if current_question < total_questions - 1 %}
                <button class="btn" onclick="nextQuestion()" id="nextBtn">
                    Siguiente ‚Üí
                </button>
                {% else %}
                <button class="btn btn-success" onclick="completeTest()" id="completeBtn">
                    Finalizar Test
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Question Navigator (Optional - for desktop) -->
    <div class="card question-navigator" id="questionNavigator">
        <div class="card-header">
            <h3 class="card-title">Navegaci√≥n R√°pida</h3>
            <button class="toggle-navigator" onclick="toggleNavigator()">üìã</button>
        </div>
        <div class="card-body navigator-body" style="display: none;">
            <div class="question-grid">
                {% for i in range(total_questions) %}
                <button class="question-btn 
                    {% if i == current_question %}current{% endif %}
                    {% if i in answered_questions %}answered{% endif %}"
                    onclick="goToQuestion({{ i }})"
                    data-question="{{ i }}">
                    {{ i + 1 }}
                </button>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Session Info (Hidden for mobile) -->
    <div class="session-info">
        <p class="text-muted">ID de sesi√≥n: {{ session_id }}</p>
        <p class="text-muted">Tiempo transcurrido: <span id="elapsed-time">0:00</span></p>
    </div>

{% endblock %}

{% block extra_css %}
<style>
    /* Question Meta */
    .question-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 12px;
    }
    
    .question-category {
        background: var(--primary-color);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 500;
    }
    
    .question-difficulty {
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 500;
    }
    
    .difficulty-easy {
        background: #d4edda;
        color: #155724;
    }
    
    .difficulty-medium {
        background: #fff3cd;
        color: #856404;
    }
    
    .difficulty-hard {
        background: #f8d7da;
        color: #721c24;
    }
    
    .question-points {
        background: var(--success-color);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 500;
    }
    
    .question-title {
        font-size: 18px;
        font-weight: 600;
        line-height: 1.4;
        margin: 0;
        color: #333;
    }
    
    /* Answer Options */
    .radio-option.selected {
        border-color: var(--primary-color);
        background-color: #e3f2fd;
    }
    
    .option-text {
        flex: 1;
        font-size: 16px;
        line-height: 1.4;
    }
    
    /* Navigation Buttons */
    .nav-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
    }
    
    .nav-info {
        text-align: center;
        flex: 1;
    }
    
    .current-position {
        font-weight: 600;
        color: var(--primary-color);
        font-size: 18px;
    }
    
    /* Question Navigator */
    .question-navigator {
        margin-top: 20px;
    }
    
    .toggle-navigator {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        padding: 4px;
    }
    
    .question-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(44px, 1fr));
        gap: 8px;
        margin-top: 12px;
    }
    
    .question-btn {
        min-height: 44px;
        border: 2px solid #dee2e6;
        background: white;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .question-btn.current {
        border-color: var(--primary-color);
        background: var(--primary-color);
        color: white;
    }
    
    .question-btn.answered {
        border-color: var(--success-color);
        background: #d4edda;
        color: var(--success-color);
    }
    
    .question-btn:hover {
        border-color: var(--primary-color);
        background: #f8f9fa;
    }
    
    /* Session Info */
    .session-info {
        margin-top: 20px;
        text-align: center;
        font-size: 12px;
    }
    
    /* Mobile Optimizations */
    @media (max-width: 767px) {
        .question-navigator {
            display: none;
        }
        
        .session-info {
            display: none;
        }
        
        .nav-buttons {
            flex-direction: column;
            gap: 12px;
        }
        
        .nav-buttons .btn {
            width: 100%;
        }
        
        .nav-info {
            order: -1;
        }
        
        .question-title {
            font-size: 16px;
        }
        
        .question-meta {
            font-size: 11px;
        }
    }
    
    @media (min-width: 768px) {
        .question-title {
            font-size: 20px;
        }
        
        .question-meta {
            font-size: 14px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let currentAnswer = {{ selected_answer if selected_answer is not none else 'null' }};
    let startTime = new Date('{{ session_start_time }}').getTime();
    let questionStartTime = Date.now();
    let timerInterval;
    
    // Initialize timer
    function updateTimer() {
        const now = Date.now();
        const elapsed = Math.floor((now - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('elapsed-time').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Start timer
    timerInterval = setInterval(updateTimer, 1000);
    updateTimer();
    
    // Select answer
    function selectAnswer(optionIndex) {
        currentAnswer = optionIndex;
        
        // Update UI
        const options = document.querySelectorAll('.radio-option');
        options.forEach((option, index) => {
            if (index === optionIndex) {
                option.classList.add('selected');
                option.querySelector('input[type="radio"]').checked = true;
            } else {
                option.classList.remove('selected');
                option.querySelector('input[type="radio"]').checked = false;
            }
        });
        
        // Save answer automatically
        saveCurrentAnswer();
    }
    
    // Save current answer
    async function saveCurrentAnswer() {
        if (currentAnswer === null) return;
        
        const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);
        
        try {
            await apiCall(`/api/sessions/{{ session_id }}/answers`, {
                method: 'POST',
                body: JSON.stringify({
                    question_id: {{ question.id }},
                    selected_answer: currentAnswer,
                    time_spent_seconds: timeSpent
                })
            });
        } catch (error) {
            console.error('Error saving answer:', error);
        }
    }
    
    // Navigation functions
    async function nextQuestion() {
        if (currentAnswer === null) {
            if (!confirm('¬øQuieres continuar sin responder esta pregunta?')) {
                return;
            }
        }
        
        await saveCurrentAnswer();
        window.location.href = `/test/{{ session_id }}/question/{{ current_question + 1 }}`;
    }
    
    async function previousQuestion() {
        await saveCurrentAnswer();
        window.location.href = `/test/{{ session_id }}/question/{{ current_question - 1 }}`;
    }
    
    async function goToQuestion(questionIndex) {
        await saveCurrentAnswer();
        window.location.href = `/test/{{ session_id }}/question/${questionIndex}`;
    }
    
    // Complete test
    async function completeTest() {
        if (currentAnswer === null) {
            if (!confirm('¬øQuieres finalizar el test sin responder esta pregunta?')) {
                return;
            }
        }
        
        if (!confirm('¬øEst√°s seguro de que quieres finalizar el test?')) {
            return;
        }
        
        showLoading(document.getElementById('completeBtn'));
        
        try {
            await saveCurrentAnswer();
            
            // Complete the test
            await apiCall(`/api/sessions/{{ session_id }}/complete`, {
                method: 'POST',
                body: JSON.stringify({})
            });
            
            window.location.href = `/results/{{ session_id }}`;
        } catch (error) {
            console.error('Error completing test:', error);
            showError('Error al finalizar el test. Int√©ntalo de nuevo.');
            hideLoading(document.getElementById('completeBtn'), 'Finalizar Test');
        }
    }
    
    // Toggle question navigator
    function toggleNavigator() {
        const body = document.querySelector('.navigator-body');
        if (body.style.display === 'none') {
            body.style.display = 'block';
        } else {
            body.style.display = 'none';
        }
    }
    
    // Confirm exit
    function confirmExit() {
        return confirm('¬øEst√°s seguro de que quieres salir del test? Se guardar√° tu progreso actual.');
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        switch(e.key) {
            case '1':
            case '2':
            case '3':
            case '4':
                e.preventDefault();
                selectAnswer(parseInt(e.key) - 1);
                break;
            case 'ArrowLeft':
                if ({{ current_question }} > 0) {
                    e.preventDefault();
                    previousQuestion();
                }
                break;
            case 'ArrowRight':
                if ({{ current_question }} < {{ total_questions - 1 }}) {
                    e.preventDefault();
                    nextQuestion();
                } else {
                    e.preventDefault();
                    completeTest();
                }
                break;
            case 'Enter':
                e.preventDefault();
                if ({{ current_question }} < {{ total_questions - 1 }}) {
                    nextQuestion();
                } else {
                    completeTest();
                }
                break;
        }
    });
    
    // Auto-save on page unload
    window.addEventListener('beforeunload', function(e) {
        if (currentAnswer !== null) {
            saveCurrentAnswer();
        }
    });
    
    // Reset question start time
    questionStartTime = Date.now();
    
    // Initialize answer selection if there's a saved answer
    if ({{ selected_answer if selected_answer is not none else 'null' }} !== null) {
        selectAnswer({{ selected_answer if selected_answer is not none else 'null' }});
    }
</script>
{% endblock %}