{% extends "base.html" %}

{% block title %}Inicio - Test Generator{% endblock %}

{% block header_title %}Test Generator{% endblock %}
{% block header_subtitle %}Sistema interactivo de tests{% endblock %}

{% block content %}
    <!-- Welcome Card -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">¬°Bienvenido!</h2>
            <p class="card-subtitle">Eval√∫a tus conocimientos sobre cualquier temario</p>
        </div>
        <div class="card-body">
            <p>Selecciona un test espec√≠fico o genera uno aleatorio para comenzar tu evaluaci√≥n.</p>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="stats-grid">
        <div class="stat-item">
            <span class="stat-number">{{ stats.total_questions or 0 }}</span>
            <span class="stat-label">Preguntas Disponibles</span>
        </div>
        <div class="stat-item">
            <span class="stat-number">{{ stats.total_sessions_completed }}</span>
            <span class="stat-label">Tests Completados</span>
        </div>
        <div class="stat-item">
            <span class="stat-number">{{ "%.0f"|format(stats.average_score_all_tests) }}%</span>
            <span class="stat-label">Puntuaci√≥n Media</span>
        </div>
        <div class="stat-item">
            <span class="stat-number">{{ available_categories|length }}</span>
            <span class="stat-label">Categor√≠as</span>
        </div>
    </div>

    <!-- Dynamic Test Generation -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Generar Test Din√°mico</h2>
            <p class="card-subtitle">Selecciona el tipo de test que deseas realizar</p>
        </div>
        <div class="card-body">
            <div class="test-mode-selection">
                <div class="test-mode-card" onclick="showRandomTestConfig()">
                    <div class="test-mode-icon">üé≤</div>
                    <h3>Test Aleatorio</h3>
                    <p>Preguntas completamente aleatorias de todos los bancos con anti-repetici√≥n inteligente</p>
                </div>
                
                <div class="test-mode-card" onclick="showCategoryTestConfig()">
                    <div class="test-mode-icon">üìÇ</div>
                    <h3>Test por Categor√≠a</h3>
                    <p>Selecciona m√∫ltiples categor√≠as con filtros avanzados</p>
                </div>
                
                <div class="test-mode-card" onclick="showDifficultyTestConfig()">
                    <div class="test-mode-icon">‚≠ê</div>
                    <h3>Test por Dificultad</h3>
                    <p>Tests filtrados por nivel de dificultad</p>
                </div>
                
                <div class="test-mode-card" onclick="startFailedQuestionsTest()">
                    <div class="test-mode-icon">üîÑ</div>
                    <h3>Repasar Fallos</h3>
                    <p>Test con preguntas previamente falladas</p>
                </div>
            </div>
            
            <!-- Admin Panel Button -->
            <div style="text-align: center; margin-top: 1.5rem;">
                <a href="/admin" class="btn" style="background: #6c757d; color: white; font-size: 0.9rem;">
                    üîß Panel Admin
                </a>
            </div>
        </div>
    </div>
    
    <!-- Random Test Configuration Modal -->
    <div id="randomTestModal" class="test-config-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üé≤ Configurar Test Aleatorio</h3>
                <button class="modal-close" onclick="closeTestModals()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="config-group">
                    <label for="randomQuestions">N√∫mero de preguntas:</label>
                    <input type="number" id="randomQuestions" value="50" min="5" max="100" class="config-input">
                    <small>M√≠nimo: 5, M√°ximo: 100. Por defecto: 50</small>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeTestModals()">Cancelar</button>
                    <button class="btn btn-primary" onclick="generateRandomTest()">üé≤ Generar Test</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Category Test Configuration Modal -->
    <div id="categoryTestModal" class="test-config-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÇ Configurar Test por Categor√≠a</h3>
                <button class="modal-close" onclick="closeTestModals()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="config-group">
                    <label for="categoryQuestions">N√∫mero de preguntas:</label>
                    <input type="number" id="categoryQuestions" value="50" min="5" max="100" class="config-input">
                </div>
                <div class="config-group">
                    <label>Categor√≠as a incluir:</label>
                    <div class="category-checkboxes" id="categoryCheckboxes">
                        <!-- Categories will be loaded dynamically -->
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeTestModals()">Cancelar</button>
                    <button class="btn btn-primary" onclick="generateCategoryTest()">üìÇ Generar Test</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Difficulty Test Configuration Modal -->
    <div id="difficultyTestModal" class="test-config-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚≠ê Configurar Test por Dificultad</h3>
                <button class="modal-close" onclick="closeTestModals()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="config-group">
                    <label for="difficultyQuestions">N√∫mero de preguntas:</label>
                    <input type="number" id="difficultyQuestions" value="50" min="5" max="100" class="config-input">
                </div>
                <div class="config-group">
                    <label for="difficultySelect">Nivel de dificultad:</label>
                    <select id="difficultySelect" class="config-input">
                        <option value="mixed">Mixto (todas las dificultades)</option>
                        <option value="easy">F√°cil</option>
                        <option value="medium">Medio</option>
                        <option value="hard">Dif√≠cil</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeTestModals()">Cancelar</button>
                    <button class="btn btn-primary" onclick="generateDifficultyTest()">‚≠ê Generar Test</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Recent Results -->
    {% if stats.recent_sessions %}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Resultados Recientes</h2>
        </div>
        <div class="card-body">
            {% for session in stats.recent_sessions %}
            <div class="recent-session">
                <div class="session-header">
                    <span class="session-title">{{ session[2] }}</span>
                    <span class="session-score score-{{ 'high' if session[3] >= 80 else 'medium' if session[3] >= 60 else 'low' }}">
                        {{ "%.0f"|format(session[3]) }}%
                    </span>
                </div>
                <div class="session-meta">
                    <span class="session-date">{{ session[4] if session[4] else 'Fecha no disponible' }}</span>
                    <span class="session-duration">‚è±Ô∏è {{ (session[5] // 60) if session[5] else 0 }} min</span>
                </div>
                <div class="session-actions">
                    <a href="/results/{{ session[0] }}" class="btn-small">üìä Ver Resultados</a>
                    {% if session[3] < 100 %}
                    <button class="btn-small btn-outline" onclick="createFailedQuestionsTest('{{ session[0] }}')">üîÅ Repasar Errores</button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="loading"></div>
            <p>Preparando tu test...</p>
        </div>
    </div>

{% endblock %}

{% block extra_css %}
<style>
    
    /* Recent Sessions */
    .recent-session {
        border-bottom: 1px solid #eee;
        padding: 12px 0;
    }
    
    .recent-session:last-child {
        border-bottom: none;
    }
    
    .session-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }
    
    .session-title {
        font-weight: 500;
        color: var(--primary-color);
        font-size: 14px;
    }
    
    .session-score {
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
    }
    
    .score-high {
        background: #d4edda;
        color: #155724;
    }
    
    .score-medium {
        background: #fff3cd;
        color: #856404;
    }
    
    .score-low {
        background: #f8d7da;
        color: #721c24;
    }
    
    .session-meta {
        display: flex;
        gap: 16px;
        font-size: 12px;
        color: #6c757d;
        margin-bottom: 8px;
    }
    
    .session-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }
    
    .btn-small {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 6px;
        text-decoration: none;
        border: 1px solid var(--primary-color);
        background: var(--primary-color);
        color: white;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    .btn-small:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }
    
    .btn-small.btn-outline {
        background: transparent;
        color: var(--primary-color);
    }
    
    .btn-small.btn-outline:hover {
        background: var(--primary-color);
        color: white;
    }
    
    /* Modal */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .modal-content {
        background: white;
        padding: 32px;
        border-radius: 12px;
        text-align: center;
        min-width: 200px;
    }
    
    .modal-content p {
        margin: 16px 0 0 0;
        color: #6c757d;
    }
    
    /* Test Mode Cards */
    .test-mode-selection {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        margin: 16px 0;
    }
    
    .test-mode-card {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }
    
    .test-mode-card:hover {
        border-color: var(--primary-color);
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    
    .test-mode-icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
    }
    
    .test-mode-card h3 {
        margin: 0 0 8px 0;
        color: var(--primary-color);
        font-size: 18px;
        font-weight: 600;
    }
    
    .test-mode-card p {
        margin: 0;
        color: #6c757d;
        font-size: 14px;
        line-height: 1.4;
    }
    
    /* Test Configuration Modals */
    .test-config-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }
    
    .test-config-modal .modal-content {
        background: white;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-header {
        padding: 20px 20px 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
    }
    
    .modal-header h3 {
        margin: 0;
        color: var(--primary-color);
        font-size: 20px;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6c757d;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
    }
    
    .modal-close:hover {
        background: #f8f9fa;
    }
    
    .modal-body {
        padding: 0 20px 20px 20px;
    }
    
    .config-group {
        margin-bottom: 20px;
    }
    
    .config-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
    }
    
    .config-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.2s;
    }
    
    .config-input:focus {
        outline: none;
        border-color: var(--primary-color);
    }
    
    .config-group small {
        display: block;
        margin-top: 4px;
        color: #6c757d;
        font-size: 12px;
    }
    
    .category-checkboxes {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        margin-top: 8px;
    }
    
    .category-checkbox {
        display: flex;
        align-items: center;
        padding: 12px;
        background: #f8f9fa;
        border: 2px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .category-checkbox:hover {
        background: #e9ecef;
    }
    
    .category-checkbox.selected {
        background: rgba(var(--primary-color-rgb), 0.1);
        border-color: var(--primary-color);
    }
    
    .category-checkbox input[type="checkbox"] {
        margin-right: 12px;
        transform: scale(1.2);
    }
    
    .category-checkbox label {
        margin: 0;
        font-weight: normal;
        cursor: pointer;
        flex: 1;
    }
    
    .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    
    .modal-actions .btn {
        min-width: 120px;
    }
    
    /* Responsive adjustments */
    @media (min-width: 768px) {
        .test-mode-selection {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .category-checkboxes {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .test-meta {
            font-size: 14px;
        }
        
        .test-title {
            font-size: 18px;
        }
    }
    
    @media (min-width: 1024px) {
        .test-mode-selection {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let availableCategories = [];
    
    // Modal management
    function showRandomTestConfig() {
        closeTestModals();
        document.getElementById('randomTestModal').style.display = 'flex';
    }
    
    function showCategoryTestConfig() {
        closeTestModals();
        loadAvailableCategories();
        document.getElementById('categoryTestModal').style.display = 'flex';
    }
    
    function showDifficultyTestConfig() {
        closeTestModals();
        document.getElementById('difficultyTestModal').style.display = 'flex';
    }
    
    function closeTestModals() {
        document.getElementById('randomTestModal').style.display = 'none';
        document.getElementById('categoryTestModal').style.display = 'none';
        document.getElementById('difficultyTestModal').style.display = 'none';
    }
    
    // Load available categories from API
    async function loadAvailableCategories() {
        try {
            const response = await fetch('/api/categories');
            if (response.ok) {
                availableCategories = await response.json();
                renderCategoryCheckboxes();
            }
        } catch (error) {
            console.error('Error loading categories:', error);
            // Fallback categories if API fails
            availableCategories = ['general', 'matematicas', 'ciencias', 'historia', 'literatura'];
            renderCategoryCheckboxes();
        }
    }
    
    // Render category checkboxes
    function renderCategoryCheckboxes() {
        const container = document.getElementById('categoryCheckboxes');
        container.innerHTML = '';
        
        availableCategories.forEach(category => {
            const checkboxDiv = document.createElement('div');
            checkboxDiv.className = 'category-checkbox';
            checkboxDiv.onclick = () => toggleCategoryCheckbox(category);
            
            checkboxDiv.innerHTML = `
                <input type="checkbox" id="cat_${category}" value="${category}">
                <label for="cat_${category}">${category}</label>
            `;
            
            container.appendChild(checkboxDiv);
        });
    }
    
    // Toggle category checkbox selection
    function toggleCategoryCheckbox(category) {
        const checkbox = document.getElementById(`cat_${category}`);
        const container = checkbox.closest('.category-checkbox');
        
        checkbox.checked = !checkbox.checked;
        
        if (checkbox.checked) {
            container.classList.add('selected');
        } else {
            container.classList.remove('selected');
        }
    }
    
    // Generate random test
    async function generateRandomTest() {
        const numQuestions = parseInt(document.getElementById('randomQuestions').value);
        
        if (numQuestions < 5 || numQuestions > 100) {
            alert('El n√∫mero de preguntas debe estar entre 5 y 100.');
            return;
        }
        
        showLoading('Generando test aleatorio...');
        closeTestModals();
        
        try {
            const response = await fetch('/api/generate-test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    test_type: 'random',
                    num_questions: numQuestions,
                    config: {}
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                window.location.href = '/test/' + result.session_id;
            } else {
                const error = await response.json();
                alert(error.detail || 'Error al generar el test aleatorio');
            }
        } catch (error) {
            console.error('Error generating random test:', error);
            alert('Error al generar el test. Int√©ntalo de nuevo.');
        } finally {
            hideLoading();
        }
    }
    
    // Generate category test
    async function generateCategoryTest() {
        const numQuestions = parseInt(document.getElementById('categoryQuestions').value);
        const selectedCategories = [];
        
        // Get selected categories
        availableCategories.forEach(category => {
            const checkbox = document.getElementById(`cat_${category}`);
            if (checkbox && checkbox.checked) {
                selectedCategories.push(category);
            }
        });
        
        if (selectedCategories.length === 0) {
            alert('Selecciona al menos una categor√≠a.');
            return;
        }
        
        if (numQuestions < 5 || numQuestions > 100) {
            alert('El n√∫mero de preguntas debe estar entre 5 y 100.');
            return;
        }
        
        showLoading('Generando test por categor√≠a...');
        closeTestModals();
        
        try {
            const response = await fetch('/api/generate-test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    test_type: 'category',
                    num_questions: numQuestions,
                    config: {
                        categories: selectedCategories
                    }
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                window.location.href = '/test/' + result.session_id;
            } else {
                const error = await response.json();
                alert(error.detail || 'Error al generar el test por categor√≠a');
            }
        } catch (error) {
            console.error('Error generating category test:', error);
            alert('Error al generar el test. Int√©ntalo de nuevo.');
        } finally {
            hideLoading();
        }
    }
    
    // Generate difficulty test
    async function generateDifficultyTest() {
        const numQuestions = parseInt(document.getElementById('difficultyQuestions').value);
        const difficulty = document.getElementById('difficultySelect').value;
        
        if (numQuestions < 5 || numQuestions > 100) {
            alert('El n√∫mero de preguntas debe estar entre 5 y 100.');
            return;
        }
        
        showLoading('Generando test por dificultad...');
        closeTestModals();
        
        try {
            const response = await fetch('/api/generate-test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    test_type: 'difficulty',
                    num_questions: numQuestions,
                    config: {
                        difficulty: difficulty
                    }
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                window.location.href = '/test/' + result.session_id;
            } else {
                const error = await response.json();
                alert(error.detail || 'Error al generar el test por dificultad');
            }
        } catch (error) {
            console.error('Error generating difficulty test:', error);
            alert('Error al generar el test. Int√©ntalo de nuevo.');
        } finally {
            hideLoading();
        }
    }
    
    // Start failed questions test (general)
    async function startFailedQuestionsTest() {
        showLoading('Generando test de repaso...');
        
        try {
            const response = await fetch('/api/generate-test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    test_type: 'failed_questions',
                    num_questions: 20,
                    config: {
                        failed_questions_only: true
                    }
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                window.location.href = '/test/' + result.session_id;
            } else {
                const error = await response.json();
                alert(error.detail || 'No hay preguntas falladas suficientes para crear un test de repaso.');
            }
        } catch (error) {
            console.error('Error starting failed questions test:', error);
            alert('Error al crear el test de repaso.');
        } finally {
            hideLoading();
        }
    }
    
    // Create test with failed questions from a session
    async function createFailedQuestionsTest(sessionId) {
        try {
            showLoading('Generando test de repaso...');
            
            const response = await fetch('/api/sessions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    test_id: 'failed_questions',
                    is_random_test: true,
                    random_config: {
                        source_session_id: sessionId,
                        failed_questions_only: true
                    }
                })
            });
            
            if (response.ok) {
                const session = await response.json();
                window.location.href = '/test/' + session.session_id;
            } else {
                alert('Error al generar el test de repaso. Int√©ntalo de nuevo.');
            }
        } catch (error) {
            alert('Error al generar el test de repaso.');
            console.error(error);
        } finally {
            hideLoading();
        }
    }
    
    // Loading functions
    function showLoading(message = 'Cargando...') {
        const loader = document.createElement('div');
        loader.id = 'loading-overlay';
        loader.innerHTML = `
            <div class="loading-content" style="background: white; padding: 40px; border-radius: 12px; text-align: center; min-width: 200px;">
                <div class="loading"></div>
                <p style="margin: 16px 0 0 0; color: #6c757d;">${message}</p>
            </div>
        `;
        loader.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        `;
        document.body.appendChild(loader);
    }
    
    function hideLoading() {
        const loader = document.getElementById('loading-overlay');
        if (loader) loader.remove();
    }
    
    // Modal close on outside click
    document.addEventListener('click', function(event) {
        const modals = document.querySelectorAll('.test-config-modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                closeTestModals();
            }
        });
    });
    
    // Escape key closes modals
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeTestModals();
        }
    });
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Add touch feedback for test mode cards
        const testModeCards = document.querySelectorAll('.test-mode-card');
        testModeCards.forEach(card => {
            card.addEventListener('touchstart', function() {
                this.style.transform = 'scale(0.98) translateY(-2px)';
            });
            card.addEventListener('touchend', function() {
                this.style.transform = '';
            });
        });
    });
</script>
{% endblock %}